window.DL=window.DL||{};window.DlMap=window.DlMap||{};window.DlListings=window.DlListings||{};(function($,_,dllocalized,Backbone,google,CustomMarkerClusterer,DlMap,DlListings,dllistings,dlgooglemap,jsonListings,DL){"use strict";function setGeocodeInputsRemoveAction(el,event){el.addEventListener(event,function(){var geocodedInputs=this.form.querySelectorAll(".geocode-input");geocodedInputs.length&&_.forEach(geocodedInputs,function(geoInput){geoInput.remove()});var geocodeNonce=this.form.querySelector("#geocode_nonce");geocodeNonce&&geocodeNonce.remove()}.bind(this))}DL.Listings=DL.Listings||{};DL.Listings.Filter={listingsListEl:function(){return document.querySelector(".dllistings-list")},useMap:function(){return Boolean(DL.Utils.Functions.classList(document.body).contains("dl-is-listings--with-map"))},useScMap:function(){var map=document.getElementById("dlgoogle-map");if(map){return Boolean(DL.Utils.Functions.classList(map).contains("dlsc-map"))}return false},visibleMap:function(){return dllistings.mapVisible||this.useScMap()},getFormTriggers:function(){return this.form.querySelectorAll(".dllistings-ajax-filter-trigger")},updateMap:function(){DlMap.map.reCenter();DlMap.map.setEvents()},buildAutoupdateList:function(){if(!_.isEmpty(this.autoUpdate)){return}var list=this.form.querySelectorAll(".is-autoupdate");if(!list){return}_.forEach(list,function(item){var slug=DL.Utils.String.toSlug(item.getAttribute("data-autoupdate"));if(!slug){return}this.autoUpdate[slug]={instance:item,filter:item.getAttribute("data-autoupdate")}}.bind(this))},updateAutoupdateFiltersMarkup:function(items){if(_.isEmpty(items)){return}_.forEach(items,function(item,key){if(!_.isUndefined(this.autoUpdate[key])){this.autoUpdate[key].instance.innerHTML=item}}.bind(this))},postData:function(callback){var data="dlajax_action=listings_filter&"+$(this.form).serialize();if(_.isEmpty(this.autoUpdate)){this.buildAutoupdateList()}_.forEach(this.autoUpdate,function(item,key){data+="&auto_update_filters["+item.filter+"]=1"});_.isFunction(callback)&&callback(data)},init:function(){if(this.visibleMap()){DlMap.map=new DlMap.Map(document.querySelector("#dlgoogle-map"),dlgooglemap);DlMap.markerCollection=new DlMap.Backbone.Collections.Marker(null,{model:DlMap.Backbone.Models.Marker})}this.archiveDescriptionModel=new DlListings.Backbone.Models.ArchiveDescription;this.archiveDescriptionView=new DlListings.Backbone.Views.ArchiveDescription({model:this.archiveDescriptionModel});this.foundPostsModel=new DlListings.Backbone.Models.FoundPosts;this.foundPostsView=new DlListings.Backbone.Views.FoundPosts({model:this.foundPostsModel});this.paginationModel=new DlListings.Backbone.Models.Pagination;this.paginationView=new DlListings.Backbone.Views.Pagination({model:this.paginationModel});this.listingsCollection=new DlListings.Backbone.Collections.Listings(null,{model:DlListings.Backbone.Models.Listings});if(!_.isEmpty(jsonListings)&&!_.isEmpty(jsonListings.posts)){this.listingsCollection.add(jsonListings.posts);if(this.visibleMap()){DlMap.markerCollection.add(jsonListings.posts);DlMap.map.markerCluster=new CustomMarkerClusterer(DlMap.map,DlMap.markerCollection.getMarkerRefs(),{gridSize:50,maxZoom:15,minimumClusterSize:2,ignoreHidden:true},_.template(document.querySelector("#dltmpl_map_markerclusterer").innerHTML));this.updateMap()}this.setPagionationAjaxTrigger();window.jsonListings=undefined}this.setTriggers()},setPagionationAjaxTrigger:function(){var self=this,pagination=document.querySelector(".dlpagination"),links;if(!pagination){return}links=pagination.querySelectorAll("a.page-numbers");if(!links.length){return}_.forEach(links,function(link){link.addEventListener("click",function(e){e.preventDefault();clearTimeout(padd);var padd=setTimeout(function(){self.filter(e)},0)})})},setTriggers:function(){if(!this.useMap()&&this.useScMap()){return}if(typeof this.form==="undefined"||null===this.form){throw"Invalid form element when set triggers."}this.form.addEventListener("submit",this.filter.bind(this));this.form.addEventListener("reset",this.filter.bind(this));_.forEach(this.getFormTriggers(),function(el){var event;switch(el.nodeName){case"SELECT":event="select2change";if("qibla_"+el.getAttribute("data-taxonomy")+"_filter"===el.getAttribute("id")){setGeocodeInputsRemoveAction.call(this,el,"select2change")}break;case"INPUT":event="change";break;default:event="click";break}el.addEventListener(event,this.filter.bind(this))}.bind(this))},noPostsFound:function(html){var container=this.listingsListEl().firstElementChild;if(!container){return}container.innerHTML=html},toggleElementsWhenFetching:function(){var archiveDescription=document.querySelector(".dlarchive-description"),archiveFooter=document.querySelector(".dlarchive-listings-footer");archiveFooter&&DL.Utils.Functions.classList(archiveFooter).toggle("is-hidden");archiveDescription&&DL.Utils.Functions.classList(archiveDescription).toggle("is-hidden")},updateListingsContainerBoxModel:function(immediate){var updateHeight=function(value){this.listingsListEl().style.height=value}.bind(this);var performUpdateHeightByCounter=function(){--counter;if(0===counter){updateHeight("auto")}};if(this.visibleMap()){return}if(immediate){updateHeight(this.listingsListEl().firstElementChild.clientHeight+"px");return}var imgs=this.listingsListEl().querySelectorAll("img"),counter=imgs.length;_.forEach(imgs,function(img){if(img.complete){performUpdateHeightByCounter()}else{$(img).load(performUpdateHeightByCounter)}}.bind(this))},filter:function(e){var collectionUrl=this.ajaxUrl;if(e instanceof Event){if(e.type!=="reset"){e.preventDefault();e.stopPropagation()}if(e.target.classList.contains("page-numbers")){collectionUrl=e.target.getAttribute("href")}else if("I"===e.target.tagName&&e.target.parentNode.classList.contains("page-numbers")){collectionUrl=e.target.parentNode.getAttribute("href")}if(e.type==="select2change"&&this.form.classList.contains("dlform-filter--open")){return}}this.listingsCollection.url=collectionUrl;var elementToScrollTo=document.body.classList.contains("is-safari")||document.body.classList.contains("is-edge")||document.body.classList.contains("is-mobile")?"body":"html";$(elementToScrollTo).animate({scrollTop:0},function(){if(this.listingsListEl()){DL.Utils.UI.toggleLoader(this.listingsListEl().firstElementChild)}this.postData(function(data){this.listingsCollection.fetch({type:"post",reset:true,silent:false,data:data,beforeSend:function(){DL.Utils.Events.dispatchEvent("listings-collection-fetching",this.form,null,{obj:this,eventParent:e});this.toggleElementsWhenFetching();this.updateListingsContainerBoxModel(true)}.bind(this),complete:function(){DL.Utils.Events.dispatchEvent("listings-collection-fetched",this.form,null,{obj:this,eventParent:e});if(this.listingsListEl().lastElementChild.classList.contains("ajax-loader")){DL.Utils.UI.toggleLoader(this.listingsListEl().firstElementChild,function(){this.updateListingsContainerBoxModel();this.toggleElementsWhenFetching()}.bind(this))}}.bind(this),success:function(collection,data,options){if(collection.models){DL.Listings.Filter.visibleMap()&&DlMap.markerCollection.reset();_.forEach(collection.models,function(model){model.trigger("update");DL.Listings.Filter.visibleMap()&&DlMap.markerCollection.add(model.attributes)})}DL.Utils.Events.dispatchEvent("listings-collection-success-fetched",this.form,null,{obj:this,eventParent:e});if(!data.foundPosts.number){this.noPostsFound(data.noContentFoundTemplate)}else{var ncf=document.querySelector(".dlnocontent-found-listings");ncf&&ncf.remove();if(DL.Listings.Filter.visibleMap()){DlMap.map.markerCluster=new CustomMarkerClusterer(DlMap.map,DlMap.markerCollection.getMarkerRefs(),{gridSize:50,maxZoom:15,minimumClusterSize:2,ignoreHidden:true},_.template(document.querySelector("#dltmpl_map_markerclusterer").innerHTML));this.updateMap()}}this.foundPostsModel.set(data.foundPosts);this.archiveDescriptionModel.set(data.archiveDescription);this.paginationModel.set(data.pagination);this.setPagionationAjaxTrigger();if("autoUpdateFilters"in data){this.updateAutoupdateFiltersMarkup(data.autoUpdateFilters)}}.bind(this)})}.bind(this))}.bind(this))},construct:function(postUrl,userPosition,formFilter){_.bindAll(this,"getFormTriggers","updateMap","postData","init","setPagionationAjaxTrigger","setTriggers","noPostsFound","toggleElementsWhenFetching","filter","updateListingsContainerBoxModel","updateAutoupdateFiltersMarkup","buildAutoupdateList");if(!formFilter&&!this.useMap()&&!this.useScMap()){return}if(formFilter){this.ajaxUrl=postUrl;this.form=formFilter;this.userPosition=userPosition;this.data=null;this.autoUpdate={}}return this}};DL.Listings.FilterFactory=function(postUrl,userPosition,formFilter){return Object.create(DL.Listings.Filter).construct(postUrl,userPosition,formFilter)};DL.Listings.FilterToggler={useMap:function(){return Boolean(DL.Utils.Functions.classList(document.body).contains("dl-is-listings--with-map"))},useScMap:function(){var map=document.getElementById("dlgoogle-map");if(map){return Boolean(DL.Utils.Functions.classList(map).contains("dlsc-map"))}return false},visibleMap:function(){return dllistings.mapVisible||this.useScMap()},toggle:function(){var self=this;this.actions.style.display="none";$(this.filters).slideToggle(375,function(){self.isOpen=!self.isOpen;if(self.isOpen){self.form.classList.add("dlform-filter--open");self.actions.style.display="block"}else{self.form.classList.remove("dlform-filter--open")}this.style.overflowY="scroll";if(self.useMap()){self.form.parentElement.style.overflowY="hidden"}if(self.isOpen){var togglerHeight=self.container.querySelector("#dltogglers");if(togglerHeight){togglerHeight=self.container.querySelector("#dltogglers").clientHeight}}else{this.style.overflowY="auto";if(self.useMap()){self.form.parentElement.style.overflowY="auto"}}})},clearFilters:function(evt){if(evt){evt.preventDefault();evt.stopPropagation()}this.form.reset();var select=this.form.querySelectorAll("select");if(select.length){_.forEach(select,function(el){el.setAttribute("selected",el.firstElementChild.getAttribute("value"));DL.Utils.Events.dispatchEvent("change",el)})}},createTogglerEL:function(){if(this.filters){var frag=document.createDocumentFragment(),togglerWrapper=document.createElement("div"),toolbar=document.querySelector("#dllistings_toolbar"),toggler=document.querySelector("#dltoggler_filter");togglerWrapper.setAttribute("id","dltogglers");togglerWrapper.classList.add("dltogglers");frag.appendChild(togglerWrapper);togglerWrapper.insertAdjacentHTML("beforeend",toggler.innerHTML);toolbar.appendChild(frag)}},init:function(){var filterTogglerEl=this.container.querySelector("#dltoggler_filters");if(filterTogglerEl){filterTogglerEl.addEventListener("click",this.toggle)}this.updateBtn.addEventListener("click",this.toggle);this.clearBtn.addEventListener("click",this.toggle);this.clearBtn.addEventListener("click",this.clearFilters);return this},construct:function(){_.bindAll(this,"init","useMap","useScMap","visibleMap","toggle","clearFilters","createTogglerEL");this.isOpen=false;if(this.useScMap()){return}this.form=document.querySelector(".dlform-filter");if(!this.form){return}this.filters=this.form.querySelector(".dlform-filter__hidden-fields");if(!this.filters){return}this.container=document.querySelector("#dllistings_toolbar");this.actions=this.filters.querySelector(".dlform-filter__actions");this.updateBtn=this.form.querySelector(".dlform-filter__action--update");this.clearBtn=this.form.querySelector(".dlform-filter__action--clear");this.createTogglerEL();return this}};DL.Listings.FilterTogglerFactory=function(){return Object.create(DL.Listings.FilterToggler).construct()};window.addEventListener("load",function(){var filter=DL.Listings.FilterFactory(dllistings.listingsAjaxUrl,DL.Geo.UserPositionFactory(),document.getElementById("dlform_filter"));filter&&filter.init();var filterToggler=DL.Listings.FilterTogglerFactory();filterToggler&&filterToggler.init()})})(jQuery,_,window.dllocalized,Backbone,window.google,window.CustomMarkerClusterer,window.DlMap,window.DlListings,window.dllistings,window.dlgooglemap,window.jsonListings,window.DL);